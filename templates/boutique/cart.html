{% extends 'boutique/base.html' %}

{% block content %}
<div class="container">
    <h2 class="section-title">Your Shopping Cart</h2>
    
    {% if cart_items %}
    <div class="cart-container">
        <div class="cart-items" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
            {% for item in cart_items %}
            <div class="cart-item" style="display: flex; border-bottom: 1px solid #eee; padding: 15px 0; align-items: center;">
                <div style="width: 100px; height: 100px; margin-right: 20px;">
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                </div>
                
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 10px 0;">{{ item.product.name }}</h3>
                    <p style="margin: 0; color: #666;">{{ item.product.category.name }}</p>
                </div>
                
                <div style="margin-right: 20px; text-align: center;">
                    <div style="font-weight: bold; color: var(--accent);">${{ item.price }}</div>
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <button class="quantity-btn" data-product-id="{{ item.product.id }}" data-action="decrease" style="background: #eee; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer;">-</button>
                        <span style="margin: 0 10px; font-weight: bold;">{{ item.quantity }}</span>
                        <button class="quantity-btn" data-product-id="{{ item.product.id }}" data-action="increase" style="background: #eee; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer;">+</button>
                    </div>
                </div>
                
                <div style="margin-right: 20px; font-weight: bold;">${{ item.total }}</div>
                
                <button class="remove-from-cart" data-product-id="{{ item.product.id }}" style="background: none; border: none; color: var(--accent); cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        
        <div class="cart-summary" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0;">Order Summary</h3>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Subtotal</span>
                <span>${{ cart_total }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Shipping</span>
                <span>$10.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold;">
                <span>Total</span>
                <span>${{ cart_total|add:10 }}</span>
            </div>
            
            <a href="{% url 'checkout' %}" class="btn" style="width: 100%;">Proceed to Checkout</a>
            <a href="{% url 'product_list' %}" class="btn" style="width: 100%; margin-top: 10px; background-color: #6c757d;">Continue Shopping</a>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 50px 0;">
        <i class="fas fa-shopping-cart" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
        <h3>Your cart is empty</h3>
        <p>Start shopping to add items to your cart</p>
        <a href="{% url 'product_list' %}" class="btn">Start Shopping</a>
    </div>
    {% endif %}
</div>

<script>
    // CSRF Token for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Cart functionality
    document.querySelectorAll('.quantity-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const action = this.getAttribute('data-action');
            
            fetch(`/cart/update/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=${action}`,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the cart.');
            });
        });
    });
    
    document.querySelectorAll('.remove-from-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            
            if (confirm('Are you sure you want to remove this item from your cart?')) {
                fetch(`/cart/remove/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while removing the item.');
                });
            }
        });
    });
</script>

<style>
    .cart-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }
    
    @media (max-width: 768px) {
        .cart-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}